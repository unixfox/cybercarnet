[{"content":"Les spams sont devenus de plus en plus présents ces dernières années. Votre adresse email est désormais dans toutes les listes des spammeurs. Les spammeurs sont plus forts que les autres pour configurer correctement le SPF, DKIM et DMARC.1 Les protections classiques ne fonctionnent plus.\nVoici comment vous protéger contre les spams en analysant vos emails avec des LLMs auto-hébergés.\nRspamd sera utilisé avec Mailcow, mais cela fonctionne aussi avec un Rspamd tout seul/isolé. Ollama sera utilisé pour sa simplicité, mais cela fonctionne aussi avec d\u0026rsquo;autres API compatible OpenAI API. Pourquoi j\u0026rsquo;ai commencé à analyser mes emails avec des LLMs ? Cela fait 10 ans que j\u0026rsquo;héberge mon propre serveur mail. La configuration par défaut de Rspamd sur Mailcow a toujours fonctionné avec un taux de blocage des spams à 95%.\nMais il y a un an, j\u0026rsquo;ai remarqué que le blocage des spams était beaucoup moins effectif qu\u0026rsquo;auparavant. À tel point que j\u0026rsquo;étais de nouveau embêté par les spams, ce qui m\u0026rsquo;était uniquement arrivé lorsque j\u0026rsquo;utilisais des services publics comme Outlook ou Gmail.\nJusqu\u0026rsquo;à ce que je découvre le plugin GPT de Rspamd.\nEst-ce que mes données sont envoyées vers le cloud propriétaire ? Le plugin GPT me recommande d\u0026rsquo;utiliser le modèle d\u0026rsquo;OpenAI GPT o4-mini. Le plugin GPT fonctionne par défaut très bien avec les modèles populaires comme o4-mini ou Gemini 2.5 flash. Mais je n\u0026rsquo;ai pas envie d\u0026rsquo;envoyer tous mes emails dans le cloud propriétaire, encore moins à OpenAI ou Google. Sans savoir ce qu\u0026rsquo;ils feront de mes données personnelles.\nDu coup, j\u0026rsquo;ai expérimenté avec Ollama et ses nombreux LLMs open source. J\u0026rsquo;ai testé une série de spam et de courriers légitimes sur les modèles Gemma, Qwen, LLama, Mistral. Et même des LLMs distillés de LLMs populaires, comme Gemma 3 distillé avec le modèle OpenAI o4 mini.\nJe recherchais un petit LLM (en dessous de 10GB) qui peut tourner confortablement sur un GPU de moyenne gamme. Principalement parce que Rspamd exige que tous les plugins répondent en moins de 30 secondes, ce qui fait que les petits LLM produisent des réponses plus rapidement.\nCe qui fonctionnait bien était une combinaison de Google Gemma 3 12B, un prompt détaillé (pas le prompt par défaut de Rspamd) et de lui donner du contexte supplémentaire de recherches Web.\nJ\u0026rsquo;ai appris que les petits LLms ne fonctionnent bien qu\u0026rsquo;avec des tâches compliquées lors que le prompt est très détaillé à propos de la tâche. Du coup, j\u0026rsquo;ai demandé à OpenAI o4 de m\u0026rsquo;écrire un prompt et voici un prompt qu\u0026rsquo;il m\u0026rsquo;a donné dont il fonctionne très bien pour toutes les situations :\nCliquez pour lire le prompt. You are an expert email evaluator analyzing messages for spam or malicious intent. Use the full content of the email, sender information, and web presence to assess its legitimacy. Assumptions:\nDKIM authentication is valid; the sender address has not been spoofed. You will be provided with the sender domain\u0026rsquo;s web presence for additional context. Evaluation Criteria:\nDomain legitimacy and sender identity (based on matching domain and content). Language, tone, and structure: assess if it resembles common phishing or scam tactics. External context: if the domain has a strong, legitimate online presence, this is a positive signal. Check if the domain activities is related to the domain used to send the email. Output exactly 3 lines:\nNumeric spam/malicious probability from 0.00 to 1.00. One-sentence justification based on the strongest risk signal (or clearest sign of legitimacy). (Only if score \u0026gt; 0.5, the concern category) phishing, scam, malware, or marketing. Leave blank otherwise. Et pour les recherches Web. J\u0026rsquo;ai eu cette idée en me disant :\nQue ferais-je si je ne connaissais pas grand-chose à propos d\u0026rsquo;une entreprise qui m\u0026rsquo;envoie un e-mail et que je voulais vérifier si elle est digne de confiance ?\nC\u0026rsquo;est particulièrement important, car les petits LLMs ont beaucoup moins de connaissances à propos du Web qu\u0026rsquo;un LLM plus large. D\u0026rsquo;après mes expérimentations, les LLMs n\u0026rsquo;arrivaient pas à correctement identifier l\u0026rsquo;agence immobilière à laquelle je loue mon appartement. Ils pensaient que c\u0026rsquo;était une arnaque. Parce qu\u0026rsquo;ils ne la connaissent pas, cette agence est peu connue pour faire part de leurs données d\u0026rsquo;entrainement.\nPour faire des recherches Web, vous pouvez utiliser n\u0026rsquo;importe quelle API de recherche. Des API propriétaires comme celle de Google, Brave ou Bing. Ou alors une API qui scrape les résultats de moteurs de recherche publics comme celle de SearXNG Search API.\nJ\u0026rsquo;ai plutôt utilisé l\u0026rsquo;API non officielle de Mullvad Leta. Ce service a comme source les résultats de Google ou Brave. Et Mullvad a fait ses preuves en matière de confidentialité des utilisateurs, et je voulais une API fiable. Mon serveur mail et mon Nextcloud sont les deux services qui doivent toujours bien fonctionner.\nDepuis la fermeture de Mullvad Leta, je suis passé à la bibliothèque ddgs qui permet d\u0026rsquo;utiliser plusieurs moteurs de recherches (ceux qui respectent ma vie privée).\nLe plugin GPT de Rspamd n\u0026rsquo;offre pas encore la possibilité d\u0026rsquo;ajouter du contexte supplémentaire d\u0026rsquo;un service externe, donc j\u0026rsquo;ai créé un proxy qui intercepte les requêtes entre le plugin et l\u0026rsquo;API de Ollama. Ce proxy ajoute au contexte les résultats de recherche Web.\nEn résumé, le fonctionnement par étape Si Rspamd a des doutes si l\u0026rsquo;email est du spam ou non. Il envoie une requête à mon proxy. Mon proxy fait une requête sur le moteur de recherche avec des informations comme qui a envoyé l\u0026rsquo;email et les liens contenus dans l\u0026rsquo;email. Le proxy envoie une requête à l\u0026rsquo;API de Ollama. Ollama répond, le proxy redirige la réponse à Rspamd. En fonction du score donné par le LLM, Rspamd classifie si l\u0026rsquo;email est du spam ou non. Guide d\u0026rsquo;installation Pré-requis Mailcow d\u0026rsquo;installé. Ollama installé localement ou sur un serveur distant. Ollama a besoin d\u0026rsquo;utiliser un GPU parce que sur CPU cela prend trop de temps à traiter. Instructions A) Configurer Ollama Ces LLMs suivants fonctionnent très bien : gemma3:12b, llama3.3:70b and qwen3:32b. J\u0026rsquo;ai choisi gemma3:12b parce qu\u0026rsquo;il a la plus petite taille.\nRécupèrer le LLM: ollama pull gemma3:12b.\nB) Configurer le plugin GPT dans Rspamd dans Mailcow Aller dans le dossier d\u0026rsquo;installation de Mailcow: /opt/mailcow-dockerized. Ouvrir le fichier data/conf/rspamd/local.d/gpt.conf. Replacer le fichier avec ce fichier de config: enabled = true; # Enable the plugin type = \u0026#34;openai\u0026#34;; # Supported types: openai, ollama api_key = \u0026#34;dummy\u0026#34; model = \u0026#34;gemma3:12b\u0026#34; temperature = 0.0; autolearn = false; max_tokens = 1000; # Maximum tokens to generate timeout = 120s; # Timeout for requests prompt = \u0026#34;You are an expert email evaluator analyzing messages for spam or malicious intent. Use the full content of the email, sender information, and web presence to assess its legitimacy. \\n Assumptions: \\n - DKIM authentication is valid; the sender address has not been spoofed. \\n - You will be provided with the sender domain\u0026#39;s web presence for additional context. \\n Evaluation Criteria: \\n 1. Domain legitimacy and sender identity (based on matching domain and content). \\n 2. Language, tone, and structure: assess if it resembles common phishing or scam tactics. \\n 3. External context: if the domain has a strong, legitimate online presence, this is a positive signal. \\n Output exactly 3 lines: \\n 1. Numeric spam/malicious probability from 0.00 to 1.00, less than 0.25 is ham and more than 0.75 is spam (if you find a concern category it\u0026#39;s a spam). \\n 2. One-sentence justification based on the strongest risk signal (or clearest sign of legitimacy). \\n 3. (Only if score \u0026gt; 0.5, the concern category) phishing, scam, malware, or marketing. Leave blank otherwise.\u0026#34; url = \u0026#34;http://rspamdgpt:8080/api/v1/chat/completions\u0026#34;; # URL for the API allow_passthrough = false; # Check messages with passthrough result allow_ham = false; # Check messages that are apparent ham (no action and negative score) reason_header = \u0026#34;X-GPT-Reason\u0026#34;; # Add header with reason (null to disable) symbols_to_except = { MAILCOW_BLACK = 1998, BAYES_SPAM = 0.9, MAILCOW_FUZZY_DENIED = 1, FUZZY_DENIED = 1, WHITELIST_SPF = -1, WHITELIST_DKIM = -1, WHITELIST_DMARC = -1, REPLY = -1, } json = false; # Use JSON format for response Redémarrer Rspamd avec docker compose restart rspamd-mailcow C) Configurer le proxy Le code source du programme se trouve dans https://github.com/unixfox/mailcow-rspamd-ollama.\nFaire un git clone du proxy dans /opt: git clone https://github.com/unixfox/mailcow-rspamd-ollama.git /opt/mailcow-rspamd-ollama Aller dans le dossier /opt/mailcow-rspamd-ollama. Configurer l\u0026rsquo;API de Ollama si vous utilisez une instance distante en changeant la variable d\u0026rsquo;environnement OLLAMA_API. Exécuter le programme avec docker compose up -d. Configuration terminée Vous pouvez tester si cela fonctionne. Mon site préféré pour tester si le setup fonctionne est de s\u0026rsquo;inscrire sur ChatGPT : https://chatgpt.com. Les emails de ChatGPT ont toujours un score de 2 dans Rspamd, ce qui déclenche la vérification par le plugin GPT.\nUtiliser la page d\u0026rsquo;administration de Rspamd pour vérifier que l\u0026rsquo;email a été analysé par le LLM : https://yourmailcowdomain/rspamd/.\nQue faire si je ne dispose pas d\u0026rsquo;un GPU suffisamment puissant pour exécuter un LLM local ? Ce proxy fonctionne avec n\u0026rsquo;importe quel API compatible OpenAI API.\nSi vous souhaitez faire attention à votre vie privée, vous pouvez utiliser un fournisseur Européen comme Nebius AI Studio (Pays-Bas) ou Mistral AI API (France).\nOu bien utiliser un GPU dédié dans le cloud, où vous paierez à l\u0026rsquo;usage par secondes/minutes d\u0026rsquo;utilisation. Runpod, Fly.io, Vast.ai ou d\u0026rsquo;autres fournisseurs.\nRetour après 6 mois d\u0026rsquo;utilisation Le setup fonctionne très bien. J\u0026rsquo;ai eu très peu de faux positifs. Environ 5 sur 2000 emails reçus et analysés par le programme.\nPour les quelques faux positifs, ils sont accessibles dans le dossier spam, donc je peux toujours les lire. Le système de score de Rspam est vraiment bon. Par défaut, si un email a un score entre 6 et 15, il est mis dans le dossier spam. Si le score est plus haut que 15, l\u0026rsquo;email est rejetté.\nDans la plupart des cas, les spams ont un score supérieur à 15 parce que le plugin GPT peut donner jusqu\u0026rsquo;à 8 points pour la classification de spam et d\u0026rsquo;hameçonnage en même temps.\nSolutions à des problèmes L\u0026rsquo;API Ollama est trop lente pour répondre à Rspamd. Augmentez le délai d\u0026rsquo;expiration de tous les plugins à 60 secondes en modifiant ce fichier : /opt/mailcow-dockerized/data/conf/rspamd/override.d/worker-normal.custom.inc.\nChanger à task_timeout = 60s;.\nhttps://toad.social/@grumpybozo/114213600922816869 (Web Archive) (Commentaires Hackernews)\u0026#160;\u0026#x21a9;\u0026#xfe0e;\n","permalink":"https://cybercarnet.eu/fr/posts/email-spam-llm/","summary":"\u003cp\u003eLes spams sont devenus de plus en plus présents ces dernières années. Votre adresse email est désormais dans toutes les listes des spammeurs. Les spammeurs sont plus forts que les autres pour configurer correctement le SPF, DKIM et DMARC.\u003csup id=\"fnref:1\"\u003e\u003ca href=\"#fn:1\" class=\"footnote-ref\" role=\"doc-noteref\"\u003e1\u003c/a\u003e\u003c/sup\u003e Les protections classiques ne fonctionnent plus.\u003c/p\u003e\n\u003cp\u003eVoici comment vous protéger contre les spams en analysant vos emails avec des LLMs auto-hébergés.\u003c/p\u003e\n\u003chr\u003e\n\u003cblockquote\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://rspamd.com\"\u003eRspamd\u003c/a\u003e sera utilisé avec \u003ca href=\"https://docs.mailcow.email/\"\u003eMailcow\u003c/a\u003e, mais cela fonctionne aussi avec un Rspamd tout seul/isolé.\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://ollama.com\"\u003eOllama\u003c/a\u003e sera utilisé pour sa simplicité, mais cela fonctionne aussi avec d\u0026rsquo;autres API compatible OpenAI API.\u003c/li\u003e\n\u003c/ul\u003e\u003c/blockquote\u003e\n\u003chr\u003e\n\u003ch2 id=\"pourquoi-jai-commencé-à-analyser-mes-emails-avec-des-llms-\"\u003ePourquoi j\u0026rsquo;ai commencé à analyser mes emails avec des LLMs ?\u003c/h2\u003e\n\u003cp\u003eCela fait 10 ans que j\u0026rsquo;héberge mon propre serveur mail. La configuration par défaut de Rspamd sur Mailcow a toujours fonctionné avec un taux de blocage des spams à 95%.\u003c/p\u003e","title":"Protégez votre serveur mail des spams grâce aux LLMs auto-hébergés"}]