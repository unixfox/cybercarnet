<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Fighting Email Spam on your Mail Server with LLMs ‚Äî Privately | CyberCarnet</title><meta name=keywords content="email,spam,ai,privacy,ollama,rspamd,mailcow"><meta name=description content="Use LLMs to reject Spam on your mail server using Rspamd and Ollama."><meta name=author content="Emilien"><link rel=canonical href=https://cybercarnet.eu/posts/email-spam-llm/><link crossorigin=anonymous href=/assets/css/stylesheet.e9192539b62076251574bf8e248e392a5b47e17b6c8b1eb7e4fe5e827f0b4fb9.css integrity="sha256-6RklObYgdiUVdL+OJI45KltH4Xtsix635P5egn8LT7k=" rel="preload stylesheet" as=style><link rel=icon href=https://cybercarnet.eu/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://cybercarnet.eu/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://cybercarnet.eu/favicon-32x32.png><link rel=apple-touch-icon href=https://cybercarnet.eu/apple-touch-icon.png><link rel=mask-icon href=https://cybercarnet.eu/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://cybercarnet.eu/posts/email-spam-llm/><link rel=alternate hreflang=fr href=https://cybercarnet.eu/fr/posts/email-spam-llm/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://cybercarnet.eu/posts/email-spam-llm/"><meta property="og:site_name" content="CyberCarnet"><meta property="og:title" content="Fighting Email Spam on your Mail Server with LLMs ‚Äî Privately"><meta property="og:description" content="Use LLMs to reject Spam on your mail server using Rspamd and Ollama."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-10-11T00:00:00+00:00"><meta property="article:modified_time" content="2025-10-11T00:00:00+00:00"><meta property="article:tag" content="Email"><meta property="article:tag" content="Spam"><meta property="article:tag" content="Ai"><meta property="article:tag" content="Privacy"><meta property="article:tag" content="Ollama"><meta property="article:tag" content="Rspamd"><meta name=twitter:card content="summary"><meta name=twitter:title content="Fighting Email Spam on your Mail Server with LLMs ‚Äî Privately"><meta name=twitter:description content="Use LLMs to reject Spam on your mail server using Rspamd and Ollama."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://cybercarnet.eu/posts/"},{"@type":"ListItem","position":2,"name":"Fighting Email Spam on your Mail Server with LLMs ‚Äî Privately","item":"https://cybercarnet.eu/posts/email-spam-llm/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Fighting Email Spam on your Mail Server with LLMs ‚Äî Privately","name":"Fighting Email Spam on your Mail Server with LLMs ‚Äî Privately","description":"Use LLMs to reject Spam on your mail server using Rspamd and Ollama.","keywords":["email","spam","ai","privacy","ollama","rspamd","mailcow"],"articleBody":"Spam emails have significantly increased over the years. Nowadays, your email address is in all spammers lists. Spammers are better at SPF, DKIM, and DMARC than everyone else.1 Traditional protections don‚Äôt work anymore.\nHere is how to effectively reduce the spam on your own mail server by scanning your emails with local LLMs.\nWe will use Rspamd with Mailcow, but this also works with a standalone Rspamd. Ollama will be used for its simplicity, but this also works with any other OpenAI compatible API. Why did I start using LLMs to scan my emails? I have been self-hosting my own mail server for 10 years. The default Rspamd configuration of Mailcow has always exceptionally blocked 95% of the spam.\nBut one year ago, I noticed the success rate of blocking those spams had reduced by a good margin. To the point I‚Äôm getting annoyed by spam again, something I only experienced when I used public email services like Outlook and Gmail.\nUntil I discovered the GPT plugin in Rspamd.\nWhere is the private part? The GPT plugin recommends me to use OpenAI GPT o4-mini. The GPT plugin works great by default with any mainstream LLMs like o4-mini or Gemini 2.5 flash. But I do not want to send my entire email to the cloud, much less to big companies like OpenAI or Google. Not knowing what they will do with my confidential info.\nSo I experimented with Ollama and its diverse number of open source LLMs. I tried a collection of spam and not-spam emails on Gemma, Qwen, LLama, and Mistral. And even distilled ones from mainstream LLMs, like Gemma 3 distilled with OpenAI o4 mini.\nI was looking for a small LLM (size under 10GB) that could run on a moderately priced GPU. Especially because Rspamd requires all plugins to respond in under 30 seconds, so a small LLM gives a quick answer.\nWhat worked great was a combination of Google Gemma 3 12B, a very detailed prompt (not the default prompt from Rspamd) and feeding the LLM with extra context from web searches.\nI learned small LLMs tend to only work great on complicated tasks when you give them a detailed prompt of the task. I asked OpenAI o4 to write me a prompt, and it gave me a perfect prompt that worked in all cases, spam and not-spam classification.\nExpand to read the prompt. You are an expert email evaluator analyzing messages for spam or malicious intent. Use the full content of the email, sender information, and web presence to assess its legitimacy. Assumptions:\nDKIM authentication is valid; the sender address has not been spoofed. You will be provided with the sender domain‚Äôs web presence for additional context. Evaluation Criteria:\nDomain legitimacy and sender identity (based on matching domain and content). Language, tone, and structure: assess if it resembles common phishing or scam tactics. External context: if the domain has a strong, legitimate online presence, this is a positive signal. Check if the domain activities is related to the domain used to send the email. Output exactly 3 lines:\nNumeric spam/malicious probability from 0.00 to 1.00. One-sentence justification based on the strongest risk signal (or clearest sign of legitimacy). (Only if score \u003e 0.5, the concern category) phishing, scam, malware, or marketing. Leave blank otherwise. And for the Web searches. This idea came up by thinking:\nWhat would I do if I had little knowledge about a company emailing me, and I wanted to fact-check if they were trustworthy?\nThis is especially important because small LLMs have less knowledge about the Web than a big LLM. Based on my testing, they were unable to correctly identify that the real estate company I rent my apartment from is legitimate, not a scam. Because they don‚Äôt know about it, this company is too little known to have landed in their trained dataset.\nFor Web searches, you can use any search engine API. Proprietary API from Google, Brave, Bing. Or APIs that scrape public search engines like SearXNG Search API.\nI personally went with the ‚Äúunofficial‚Äù API of Mullvad Leta. This service fetches search results from Google or Brave. And Mullvad has a good track record for user privacy, and I wanted a reliable API. My mail server and my own Nextcloud are the two things that need to work reliably.\nSince the shutdown of Mullvad Leta, I switched to the library ddgs which allow using multiple engines (only the ones that respect my privacy).\nThe Rspamd GPT plugin doesn‚Äôt yet offer the ability to dynamically add more context from an external service, so I created a proxy that intercepts the request between the plugin and the Ollama API. This proxy adds the web searches in the context.\nThe workflow in summary If Rspamd has doubts if it‚Äôs a spam or not. It sends a request to my proxy. My proxy request from the search engine the search results for who sent the email and the links included in the email. The proxy sends the request to Ollama API. Ollama respond, the proxy forward the request to Rspamd. Based on the score given by the LLM, Rspamd classify the email as spam or not. How to replicate my setup. Prerequisites Mailcow installed. Ollama installed locally or on a remote server. Ollama need to run on a GPU, LLMs takes too much time to respond on a CPU. Instructions A) Configure Ollama I had good success with these LLMs: gemma3:12b, llama3.3:70b and qwen3:32b. I did stick with gemma3:12b which have the smallest size.\nPrefetch the LLM: ollama pull gemma3:12b.\nB) Configure GPT plugin in Rspamd in Mailcow Go to the Mailcow installation folder: /opt/mailcow-dockerized. Edit the file in data/conf/rspamd/local.d/gpt.conf. Replace the file with this config file: enabled = true; # Enable the plugin type = \"openai\"; # Supported types: openai, ollama api_key = \"dummy\" model = \"gemma3:12b\" temperature = 0.0; autolearn = false; max_tokens = 1000; # Maximum tokens to generate timeout = 120s; # Timeout for requests prompt = \"You are an expert email evaluator analyzing messages for spam or malicious intent. Use the full content of the email, sender information, and web presence to assess its legitimacy. \\n Assumptions: \\n - DKIM authentication is valid; the sender address has not been spoofed. \\n - You will be provided with the sender domain's web presence for additional context. \\n Evaluation Criteria: \\n 1. Domain legitimacy and sender identity (based on matching domain and content). \\n 2. Language, tone, and structure: assess if it resembles common phishing or scam tactics. \\n 3. External context: if the domain has a strong, legitimate online presence, this is a positive signal. \\n Output exactly 3 lines: \\n 1. Numeric spam/malicious probability from 0.00 to 1.00, less than 0.25 is ham and more than 0.75 is spam (if you find a concern category it's a spam). \\n 2. One-sentence justification based on the strongest risk signal (or clearest sign of legitimacy). \\n 3. (Only if score \u003e 0.5, the concern category) phishing, scam, malware, or marketing. Leave blank otherwise.\" url = \"http://rspamdgpt:8080/api/v1/chat/completions\"; # URL for the API allow_passthrough = false; # Check messages with passthrough result allow_ham = false; # Check messages that are apparent ham (no action and negative score) reason_header = \"X-GPT-Reason\"; # Add header with reason (null to disable) symbols_to_except = { MAILCOW_BLACK = 1998, BAYES_SPAM = 0.9, MAILCOW_FUZZY_DENIED = 1, FUZZY_DENIED = 1, WHITELIST_SPF = -1, WHITELIST_DKIM = -1, WHITELIST_DMARC = -1, REPLY = -1, } json = false; # Use JSON format for response Restart rspamd with docker compose restart rspamd-mailcow C) Configure the proxy The program source code is located at https://github.com/unixfox/mailcow-rspamd-ollama.\nGit clone the proxy to /opt with: git clone https://github.com/unixfox/mailcow-rspamd-ollama.git /opt/mailcow-rspamd-ollama Go to /opt/mailcow-rspamd-ollama. Configure the Ollama API URL if you are using a remote ollama instance by changing the environment variable OLLAMA_API. Run the program with docker compose up -d. That‚Äôs all. You can now try if it works for you. My go-to website to test if the setup works is to register a dummy account on https://chatgpt.com. ChatGPT registration emails always have a score of 2 in Rspamd which results in triggering the GPT plugin.\nUse the Rspamd administration page to see if the email was scanned by the LLM: https://yourmailcowdomain/rspamd/.\nWhat if I don‚Äôt have a GPU powerful enough to run a local LLM? The proxy works with any OpenAI compatible.\nIf you are conscious about privacy, you can use European providers like Nebius AI Studio (Netherlands) or Mistral AI API (France).\nOr use a dedicated GPU in the cloud, where you pay per seconds/minutes of usage. Runpod, Fly.io, Vast.ai or any other providers.\nFeedback after 6 months of using it It works great. I have had very few false positives; I would say 5 out of the 2000 emails scanned by the program.\nFor the few false positives, they land in my spam folder so they don‚Äôt get lost, and I can still read them. Rspamd scoring system is great; by default, if an email has a score between 6 and 15, it gets moved to the spam folder. Higher than that, the email is rejected.\nIn most cases, spam receives a score higher than 15, as the GPT plugin can assign up to 8 points for spam and phishing detection combined.\nTroubleshooting Ollama API is too slow to respond for Rspamd Increase all the plugins timeout to 60s by tuning this file /opt/mailcow-dockerized/data/conf/rspamd/override.d/worker-normal.custom.inc.\nChange to task_timeout = 60s;.\nhttps://toad.social/@grumpybozo/114213600922816869 (Web Archive) (Hackernews comments)¬†‚Ü©Ô∏é\n","wordCount":"1581","inLanguage":"en","datePublished":"2025-10-11T00:00:00Z","dateModified":"2025-10-11T00:00:00Z","author":{"@type":"Person","name":"Emilien"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://cybercarnet.eu/posts/email-spam-llm/"},"publisher":{"@type":"Organization","name":"CyberCarnet","logo":{"@type":"ImageObject","url":"https://cybercarnet.eu/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://cybercarnet.eu/ accesskey=h title="CyberCarnet (Alt + H)">CyberCarnet</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://cybercarnet.eu/fr/ title=French aria-label=:fr:>üá´üá∑</a></li></ul></div></div><ul id=menu><li><a href=https://cybercarnet.eu/archives title=Archive><span>Archive</span></a></li><li><a href=https://cybercarnet.eu/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://cybercarnet.eu/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://cybercarnet.eu/index.xml title=RSS><span>RSS</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://cybercarnet.eu/>Home</a>&nbsp;¬ª&nbsp;<a href=https://cybercarnet.eu/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Fighting Email Spam on your Mail Server with LLMs ‚Äî Privately</h1><div class=post-description>Use LLMs to reject Spam on your mail server using Rspamd and Ollama.</div><div class=post-meta><span title='2025-10-11 00:00:00 +0000 UTC'>October 11, 2025</span>&nbsp;¬∑&nbsp;Emilien&nbsp;|&nbsp;Translations:<ul class=i18n_list><li><a href=https://cybercarnet.eu/fr/posts/email-spam-llm/>üá´üá∑</a></li></ul></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#why-did-i-start-using-llms-to-scan-my-emails aria-label="Why did I start using LLMs to scan my emails?">Why did I start using LLMs to scan my emails?</a></li><li><a href=#where-is-the-private-part-the-gpt-plugin-recommends-me-to-use-openai-gpt-o4-mini aria-label="Where is the private part? The GPT plugin recommends me to use OpenAI GPT o4-mini.">Where is the private part? The GPT plugin recommends me to use OpenAI GPT o4-mini.</a></li><li><a href=#the-workflow-in-summary aria-label="The workflow in summary">The workflow in summary</a></li><li><a href=#how-to-replicate-my-setup aria-label="How to replicate my setup.">How to replicate my setup.</a><ul><li><a href=#prerequisites aria-label=Prerequisites>Prerequisites</a></li><li><a href=#instructions aria-label=Instructions>Instructions</a><ul><li><a href=#a-configure-ollama aria-label="A) Configure Ollama">A) Configure Ollama</a></li><li><a href=#b-configure-gpt-plugin-in-rspamd-in-mailcow aria-label="B) Configure GPT plugin in Rspamd in Mailcow">B) Configure GPT plugin in Rspamd in Mailcow</a></li><li><a href=#c-configure-the-proxy aria-label="C) Configure the proxy">C) Configure the proxy</a></li><li><a href=#thats-all aria-label="That&rsquo;s all.">That&rsquo;s all.</a></li></ul></li><li><a href=#what-if-i-dont-have-a-gpu-powerful-enough-to-run-a-local-llm aria-label="What if I don&rsquo;t have a GPU powerful enough to run a local LLM?">What if I don&rsquo;t have a GPU powerful enough to run a local LLM?</a></li><li><a href=#feedback-after-6-months-of-using-it aria-label="Feedback after 6 months of using it">Feedback after 6 months of using it</a></li><li><a href=#troubleshooting aria-label=Troubleshooting>Troubleshooting</a><ul><li><a href=#ollama-api-is-too-slow-to-respond-for-rspamd aria-label="Ollama API is too slow to respond for Rspamd">Ollama API is too slow to respond for Rspamd</a></li></ul></li></ul></li></ul></div></details></div><div class=post-content><p>Spam emails have significantly increased over the years. Nowadays, your email address is in all spammers lists. Spammers are better at SPF, DKIM, and DMARC than everyone else.<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup> Traditional protections don&rsquo;t work anymore.</p><p>Here is how to effectively reduce the spam on your own mail server by scanning your emails with local LLMs.</p><hr><blockquote><ul><li>We will use <a href=https://rspamd.com>Rspamd</a> with <a href=https://docs.mailcow.email/>Mailcow</a>, but this also works with a standalone Rspamd.</li><li><a href=https://ollama.com>Ollama</a> will be used for its simplicity, but this also works with any other OpenAI compatible API.</li></ul></blockquote><hr><h2 id=why-did-i-start-using-llms-to-scan-my-emails>Why did I start using LLMs to scan my emails?<a hidden class=anchor aria-hidden=true href=#why-did-i-start-using-llms-to-scan-my-emails>#</a></h2><p>I have been self-hosting my own mail server for 10 years. The default Rspamd configuration of Mailcow has always exceptionally blocked 95% of the spam.</p><p>But one year ago, I noticed the success rate of blocking those spams had reduced by a good margin. To the point I&rsquo;m getting annoyed by spam again, something I only experienced when I used public email services like Outlook and Gmail.</p><p>Until I discovered the <a href=https://docs.rspamd.com/modules/gpt/>GPT plugin</a> in Rspamd.</p><h2 id=where-is-the-private-part-the-gpt-plugin-recommends-me-to-use-openai-gpt-o4-mini>Where is the private part? The GPT plugin recommends me to use OpenAI GPT o4-mini.<a hidden class=anchor aria-hidden=true href=#where-is-the-private-part-the-gpt-plugin-recommends-me-to-use-openai-gpt-o4-mini>#</a></h2><p>The GPT plugin works great by default with any mainstream LLMs like o4-mini or Gemini 2.5 flash. But I do not want to send my entire email to the cloud, much less to big companies like OpenAI or Google. Not knowing what they will do with my confidential info.</p><p>So I experimented with Ollama and its diverse number of open source LLMs. I tried a collection of spam and not-spam emails on Gemma, Qwen, LLama, and Mistral. And even distilled ones from mainstream LLMs, like Gemma 3 distilled with OpenAI o4 mini.</p><p>I was looking for a small LLM (size under 10GB) that could run on a moderately priced GPU. Especially because Rspamd requires all plugins to respond in under 30 seconds, so a small LLM gives a quick answer.</p><p>What worked great was a combination of Google Gemma 3 12B, a very detailed prompt (not the default prompt from Rspamd) and feeding the LLM with extra context from web searches.</p><p>I learned small LLMs tend to only work great on complicated tasks when you give them a detailed prompt of the task. I asked OpenAI o4 to write me a prompt, and it gave me a perfect prompt that worked in all cases, spam and not-spam classification.</p><blockquote><p><details><summary markdown=span>Expand to read the prompt.</summary><p>You are an expert email evaluator analyzing messages for spam or malicious intent. Use the full content of the email, sender information, and web presence to assess its legitimacy.
Assumptions:</p><ul><li>DKIM authentication is valid; the sender address has not been spoofed.</li><li>You will be provided with the sender domain&rsquo;s web presence for additional context.</li></ul><p>Evaluation Criteria:</p><ol><li>Domain legitimacy and sender identity (based on matching domain and content).</li><li>Language, tone, and structure: assess if it resembles common phishing or scam tactics.</li><li>External context: if the domain has a strong, legitimate online presence, this is a positive signal.</li><li>Check if the domain activities is related to the domain used to send the email.</li></ol><p>Output exactly 3 lines:</p><ol><li>Numeric spam/malicious probability from 0.00 to 1.00.</li><li>One-sentence justification based on the strongest risk signal (or clearest sign of legitimacy).</li><li>(Only if score > 0.5, the concern category) phishing, scam, malware, or marketing. Leave blank otherwise.</li></ol></details></p></blockquote><p>And for the Web searches. This idea came up by thinking:</p><blockquote><p>What would I do if I had little knowledge about a company emailing me, and I wanted to fact-check if they were trustworthy?</p></blockquote><p>This is especially important because small LLMs have less knowledge about the Web than a big LLM. Based on my testing, they were unable to correctly identify that the real estate company I rent my apartment from is legitimate, not a scam. Because they don&rsquo;t know about it, this company is too little known to have landed in their trained dataset.</p><p>For Web searches, you can use any search engine API. Proprietary API from Google, Brave, Bing. Or APIs that scrape public search engines like <a href=https://docs.searxng.org/dev/search_api.html>SearXNG Search API</a>.</p><p><del>I personally went with the &ldquo;unofficial&rdquo; API of <a href=https://leta.mullvad.net>Mullvad Leta</a>. This service fetches search results from Google or Brave. And Mullvad has a good track record for user privacy, and I wanted a reliable API. My mail server and my own Nextcloud are the two things that need to work reliably.</del></p><p>Since the shutdown of <a href=https://mullvad.net/en/blog/shutting-down-our-search-proxy-leta>Mullvad Leta</a>, I switched to the library <a href=https://github.com/deedy5/ddgs>ddgs</a> which allow using multiple engines (only the ones that respect my privacy).</p><p>The Rspamd GPT plugin doesn&rsquo;t yet offer the ability to dynamically add more context from an external service, so I created a proxy that intercepts the request between the plugin and the Ollama API. This proxy adds the web searches in the context.</p><h2 id=the-workflow-in-summary>The workflow in summary<a hidden class=anchor aria-hidden=true href=#the-workflow-in-summary>#</a></h2><ol><li>If Rspamd has doubts if it&rsquo;s a spam or not. It sends a request to my proxy.</li><li>My proxy request from the search engine the search results for who sent the email and the links included in the email.</li><li>The proxy sends the request to Ollama API.</li><li>Ollama respond, the proxy forward the request to Rspamd.</li><li>Based on the score given by the LLM, Rspamd classify the email as spam or not.</li></ol><h2 id=how-to-replicate-my-setup>How to replicate my setup.<a hidden class=anchor aria-hidden=true href=#how-to-replicate-my-setup>#</a></h2><h3 id=prerequisites>Prerequisites<a hidden class=anchor aria-hidden=true href=#prerequisites>#</a></h3><ul><li><a href=https://mailcow.email>Mailcow</a> installed.</li><li><a href=https://ollama.com>Ollama</a> installed locally or on a remote server.</li><li>Ollama need to run on a GPU, LLMs takes too much time to respond on a CPU.</li></ul><h3 id=instructions>Instructions<a hidden class=anchor aria-hidden=true href=#instructions>#</a></h3><h4 id=a-configure-ollama>A) Configure Ollama<a hidden class=anchor aria-hidden=true href=#a-configure-ollama>#</a></h4><p>I had good success with these LLMs: <code>gemma3:12b</code>, <code>llama3.3:70b</code> and <code>qwen3:32b</code>. I did stick with <code>gemma3:12b</code> which have the smallest size.</p><p>Prefetch the LLM: <code>ollama pull gemma3:12b</code>.</p><h4 id=b-configure-gpt-plugin-in-rspamd-in-mailcow>B) Configure GPT plugin in Rspamd in Mailcow<a hidden class=anchor aria-hidden=true href=#b-configure-gpt-plugin-in-rspamd-in-mailcow>#</a></h4><ol><li>Go to the Mailcow installation folder: <code>/opt/mailcow-dockerized</code>.</li><li>Edit the file in <code>data/conf/rspamd/local.d/gpt.conf</code>.</li><li>Replace the file with this config file:</li></ol><pre tabindex=0><code>enabled = true; # Enable the plugin
type = &#34;openai&#34;; # Supported types: openai, ollama
api_key = &#34;dummy&#34;
model = &#34;gemma3:12b&#34;
temperature = 0.0;
autolearn = false;
max_tokens = 1000; # Maximum tokens to generate
timeout = 120s; # Timeout for requests
prompt = &#34;You are an expert email evaluator analyzing messages for spam or malicious intent. Use the full content of the email, sender information, and web presence to assess its legitimacy. \n Assumptions: \n - DKIM authentication is valid; the sender address has not been spoofed. \n - You will be provided with the sender domain&#39;s web presence for additional context. \n Evaluation Criteria: \n 1. Domain legitimacy and sender identity (based on matching domain and content). \n 2. Language, tone, and structure: assess if it resembles common phishing or scam tactics. \n 3. External context: if the domain has a strong, legitimate online presence, this is a positive signal. \n Output exactly 3 lines: \n 1. Numeric spam/malicious probability from 0.00 to 1.00, less than 0.25 is ham and more than 0.75 is spam (if you find a concern category it&#39;s a spam). \n 2. One-sentence justification based on the strongest risk signal (or clearest sign of legitimacy). \n 3. (Only if score &gt; 0.5, the concern category) phishing, scam, malware, or marketing. Leave blank otherwise.&#34;
url = &#34;http://rspamdgpt:8080/api/v1/chat/completions&#34;; # URL for the API
allow_passthrough = false; # Check messages with passthrough result
allow_ham = false; # Check messages that are apparent ham (no action and negative score)
reason_header = &#34;X-GPT-Reason&#34;; # Add header with reason (null to disable)
symbols_to_except = { MAILCOW_BLACK = 1998, BAYES_SPAM = 0.9, MAILCOW_FUZZY_DENIED = 1, FUZZY_DENIED = 1, WHITELIST_SPF = -1, WHITELIST_DKIM = -1, WHITELIST_DMARC = -1, REPLY = -1, }
json = false; # Use JSON format for response
</code></pre><ol start=4><li>Restart rspamd with <code>docker compose restart rspamd-mailcow</code></li></ol><h4 id=c-configure-the-proxy>C) Configure the proxy<a hidden class=anchor aria-hidden=true href=#c-configure-the-proxy>#</a></h4><p>The program source code is located at <a href=https://github.com/unixfox/mailcow-rspamd-ollama>https://github.com/unixfox/mailcow-rspamd-ollama</a>.</p><ol><li>Git clone the proxy to /opt with:<pre tabindex=0><code>git clone https://github.com/unixfox/mailcow-rspamd-ollama.git /opt/mailcow-rspamd-ollama
</code></pre></li><li>Go to <code>/opt/mailcow-rspamd-ollama</code>.</li><li>Configure the Ollama API URL if you are using a remote ollama instance by changing the environment variable <code>OLLAMA_API</code>.</li><li>Run the program with <code>docker compose up -d</code>.</li></ol><h4 id=thats-all>That&rsquo;s all.<a hidden class=anchor aria-hidden=true href=#thats-all>#</a></h4><p>You can now try if it works for you. My go-to website to test if the setup works is to register a dummy account on <a href=https://chatgpt.com>https://chatgpt.com</a>. ChatGPT registration emails always have a score of 2 in Rspamd which results in triggering the GPT plugin.</p><p>Use the Rspamd administration page to see if the email was scanned by the LLM: https://yourmailcowdomain/rspamd/.</p><p><img alt=regular loading=lazy src=/images/2025-07-19_19-49-rspamd-admin-gpt.png></p><h3 id=what-if-i-dont-have-a-gpu-powerful-enough-to-run-a-local-llm>What if I don&rsquo;t have a GPU powerful enough to run a local LLM?<a hidden class=anchor aria-hidden=true href=#what-if-i-dont-have-a-gpu-powerful-enough-to-run-a-local-llm>#</a></h3><p>The proxy works with any OpenAI compatible.</p><p>If you are conscious about privacy, you can use European providers like <a href=https://studio.nebius.com>Nebius AI Studio</a> (Netherlands) or <a href=https://mistral.ai>Mistral AI API</a> (France).</p><p>Or use a dedicated GPU in the cloud, where you pay per seconds/minutes of usage. <a href=https://www.runpod.io>Runpod</a>, <a href=https://fly.io/gpu>Fly.io</a>, <a href=https://vast.ai>Vast.ai</a> or any other providers.</p><h3 id=feedback-after-6-months-of-using-it>Feedback after 6 months of using it<a hidden class=anchor aria-hidden=true href=#feedback-after-6-months-of-using-it>#</a></h3><p>It works great. I have had very few false positives; I would say 5 out of the 2000 emails scanned by the program.</p><p>For the few false positives, they land in my spam folder so they don&rsquo;t get lost, and I can still read them. Rspamd scoring system is great; by default, if an email has a score between 6 and 15, it gets moved to the spam folder. Higher than that, the email is rejected.</p><p>In most cases, spam receives a score higher than 15, as the GPT plugin can assign up to 8 points for spam and phishing detection combined.</p><p><img alt=regular loading=lazy src=/images/2025-10-11_10-53.png></p><h3 id=troubleshooting>Troubleshooting<a hidden class=anchor aria-hidden=true href=#troubleshooting>#</a></h3><h4 id=ollama-api-is-too-slow-to-respond-for-rspamd>Ollama API is too slow to respond for Rspamd<a hidden class=anchor aria-hidden=true href=#ollama-api-is-too-slow-to-respond-for-rspamd>#</a></h4><p>Increase all the plugins timeout to 60s by tuning this file <code>/opt/mailcow-dockerized/data/conf/rspamd/override.d/worker-normal.custom.inc</code>.</p><p>Change to <code>task_timeout = 60s;</code>.</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p><a href=https://toad.social/@grumpybozo/114213600922816869>https://toad.social/@grumpybozo/114213600922816869</a> (<a href=https://web.archive.org/web/20250409191904/https://toad.social/@grumpybozo/114213600922816869>Web Archive</a>) (<a href="https://news.ycombinator.com/item?id=43468995">Hackernews comments</a>)&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://cybercarnet.eu/tags/email/>Email</a></li><li><a href=https://cybercarnet.eu/tags/spam/>Spam</a></li><li><a href=https://cybercarnet.eu/tags/ai/>Ai</a></li><li><a href=https://cybercarnet.eu/tags/privacy/>Privacy</a></li><li><a href=https://cybercarnet.eu/tags/ollama/>Ollama</a></li><li><a href=https://cybercarnet.eu/tags/rspamd/>Rspamd</a></li><li><a href=https://cybercarnet.eu/tags/mailcow/>Mailcow</a></li></ul><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share Fighting Email Spam on your Mail Server with LLMs ‚Äî Privately on x" href="https://x.com/intent/tweet/?text=Fighting%20Email%20Spam%20on%20your%20Mail%20Server%20with%20LLMs%20%e2%80%94%20Privately&amp;url=https%3a%2f%2fcybercarnet.eu%2fposts%2femail-spam-llm%2f&amp;hashtags=email%2cspam%2cai%2cprivacy%2collama%2crspamd%2cmailcow"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Fighting Email Spam on your Mail Server with LLMs ‚Äî Privately on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fcybercarnet.eu%2fposts%2femail-spam-llm%2f&amp;title=Fighting%20Email%20Spam%20on%20your%20Mail%20Server%20with%20LLMs%20%e2%80%94%20Privately&amp;summary=Fighting%20Email%20Spam%20on%20your%20Mail%20Server%20with%20LLMs%20%e2%80%94%20Privately&amp;source=https%3a%2f%2fcybercarnet.eu%2fposts%2femail-spam-llm%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Fighting Email Spam on your Mail Server with LLMs ‚Äî Privately on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fcybercarnet.eu%2fposts%2femail-spam-llm%2f&title=Fighting%20Email%20Spam%20on%20your%20Mail%20Server%20with%20LLMs%20%e2%80%94%20Privately"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Fighting Email Spam on your Mail Server with LLMs ‚Äî Privately on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fcybercarnet.eu%2fposts%2femail-spam-llm%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Fighting Email Spam on your Mail Server with LLMs ‚Äî Privately on whatsapp" href="https://api.whatsapp.com/send?text=Fighting%20Email%20Spam%20on%20your%20Mail%20Server%20with%20LLMs%20%e2%80%94%20Privately%20-%20https%3a%2f%2fcybercarnet.eu%2fposts%2femail-spam-llm%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Fighting Email Spam on your Mail Server with LLMs ‚Äî Privately on telegram" href="https://telegram.me/share/url?text=Fighting%20Email%20Spam%20on%20your%20Mail%20Server%20with%20LLMs%20%e2%80%94%20Privately&amp;url=https%3a%2f%2fcybercarnet.eu%2fposts%2femail-spam-llm%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentColor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Fighting Email Spam on your Mail Server with LLMs ‚Äî Privately on ycombinator" href="https://news.ycombinator.com/submitlink?t=Fighting%20Email%20Spam%20on%20your%20Mail%20Server%20with%20LLMs%20%e2%80%94%20Privately&u=https%3a%2f%2fcybercarnet.eu%2fposts%2femail-spam-llm%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>MIT</span> ¬∑
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>